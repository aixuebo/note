# 背景与总结
## 1.IDL层，即Fact模型的作用 -- 基于ER建模
① 目标
解耦，用ER方式建模，对真实业务做抽象，解耦。
比如真实业务订单来自于多个业务系统，那IDL层主要做抽象，让数仓只知道订单即可，解耦下游多业务系统。
价值：业务系统的变更，仅影响IDL，对其他数仓分层解耦，减少业务系统改造，带来的风险。

② ER建模
业务系统侧和数仓共同维护实体之间的关系，比如谁和谁是一对一，谁和谁是多对多。
有了这层关系，就可以再IDL层做模型抽象了。解耦了业务系统与数仓的影响。

## 2.为什么CDL层要有两种组合 -- 基于范式建模
① 视角
业务视角：业务主题 + 业务过程，可以明确反应业务真实状态。
分析视角: 分析对象 --- 数仓主要在研究分析对象，针对分析对象编程。

② 组合
分析对象 + 业务过程 --> 核心模型 --> 反应的是业务过程归属的分析视角，产生原子指标+维度。
分析对象 + 业务主题 --> 非核心模型 --> 依赖核心模型，跨业务主题编程，既然跨业务主题，那每一个业务主题应该需要的指标和维度放在一起。

# 一、Aggr - CDL层模型建设
## 1.分析对象 + 业务过程 --常用于核心模型的收口
* 订单+提单、订单+支付。
* 指标和维度，口径要下沉到Aggr的业务过程模型里。这样Aggr核心模型数量是可控的，仅受业务过程数量限制。
* 一个指标和维度，仅会出现在一个业务过程里，所以一定是要确保唯一性。
* 属于范式建模。不要冗余其他模型的属性，比如订单里不要冗余商家属性信息。

## 2.分析对象 + 主体建模 -- 常用于非核心模型
① 分析对象 + 业务主体 --> 进行建设动态指标集。
② 例子
* 标准菜分析对象 + 交易，比如某一个标准菜，标杆spu(他top1销量的商品是什么)、标杆商品销量。
* 城市粒度标准菜分析对象 + ，即按照标准菜+city为主键进行分析的场景。
③ 注意事项:
* 自己不定义指标口径，相当于topic，需要依赖核心aggr模型，进行简单的left join建设。
* 属于范式建模。

## 3.注意事项
① 一定要按照业务视角建模，而不是技术视角建模。
* 比如从各种复杂的json格式里解析属性值，应该放到view视图里，或者放到静态属性里。而不是作为xml一样的形式，单独创建一个ord_attribute对象。（当然这个例子比较特殊，这么创建也是没有问题的）
* 比如商品可累加指标表、不可累加表，就不是好的建模方式，更偏技术了。
应该是商品作为分析对象+交易(用户数不可累加指标建模+订单量可累加指标都在一起)、商品作为分析对象+流量

# 二、CDL层建模案例分析
## 1.核心模型-case
分析对象：订单
业务过程：提单
字段：下单时段、是否完成订单、收餐城市、出餐城市、用户定位城市

注意：
* 基于 分析对象 + 业务过程建模。
* 口径收口在核心对象里，指标和维度的口径本身应该属于该业务过程。

## 2.非核心模型-case
分析对象：商家
分析主题：交易
字段：是否主营xxx业务商家(看大盘订单量和xxx业务订单量做比较)

注意：
* 基于 分析对象 + 分析主题建模。
* 非核心对象：口径来自于核心对象，基于核心对象的预聚合，以及派生维度生产。

## 3.是否餐饮商家，是否放在订单-提单的CDL模型里
不要，因为他属于商家属性，应该在MDL层建模的时候，进行冗余进来。而不是在CDL层建模冗余。

## 4.是否新客首单、是否某一个子业务新客首单，这个属于订单粒度的标签，应该放在订单表里，还是放在用户表里，还是放在用户首次交易里?
答案是：放在新客订单表里。属于非核心模型。
分析对象：用户。
分析主题：首次交易。

* 为什么不放在用户表里。
因为他是订单粒度的，而不是用户粒度的，要统计首单订单数，所以不能放到用户标签里。

* 为什么不能放在订单表里
因为他需要扫描历史订单表，是否出现过新客。（即使该信息由业务系统透传到数仓，也应该单独看，毕竟分析视角不同；而且用户也存在退单行为，数仓应该有自己的首单定义）

* 为什么这个不放在订单分析对象里，而放到用户分析对象里呢？
因为首次的分析对象，不是订单，而是用户。
订单只是首次用户的附加属性，比如用户首次订单是什么，从什么渠道来的，等等首次相关的多业务主题的指标和维度，都应该归属到一个用户视角上。

## 5.来自于log表或者第三方表接入，是否应该融合在业务过程里？
比如 商品录入的时候，有一个谁录入的，来自于日志表，但站在业务视角看，都属于录入这个业务过程，但技术视角看，他来自于不同的系统，在数仓建模时，要按照技术视角建模，还是按照业务视角建模呢？

这个问题，要按照技术视角建模，而不是业务视角建模。(但也要看这个字段的权重，是否很重要，如果很重要，能保障上游SLA，也是应该按照业务视角建模的)

按照技术视角，拆分成多个模型的原因：
* 上游就绪时间不同。（第三方的模型可能是app表）
* 上游稳定性差异，log表或者第三方的模型可能是app表，可能存在bug，导致回刷，而下游用到该模型的结果的依赖并不多，所以需要单独拆开。

## 6.提单、支付等订单环节，都存在log或者json字段，从中解析成物化字段作为维度，需要在不同的业务过程里不断修改增加吗？
这个仁者见仁了，理论上应该在提单、支付的业务过程里，进行解析。
缺点:
* 不断加字段，变更和回刷模型。
* 表内字段越来越多。

其他解决方案:
* 多业务过程建模，融合在一个对象里，统一解析。缺点是如果上游表就绪时间不同，会有影响，但感觉这个不是很重要，完全可以用就绪时间在拆一层。
* 为每一个业务过程，创建一个view视图，在视图里解析，但这个不好用。下游单独新依赖一个view。

## 7.是否新签商家、首次新签商家日期，这两个应该有两个模型支持，而不是一个模型
这个跟订单、首购订单逻辑一样。
新签是一个业务过程，基于该业务过程，查询历史数据，生产首次新签逻辑。

## 8.在售爆品 = 在售 && 爆品 ，分别来自于不同的业务过程，一个来自于商品录入是否爆品，一个来自于商品上下架流水，应该如何拆解呢
* 方案1：推荐方案，单独模型
单独一个任务，依赖商品录入、上下架表，相当于对CDL层自己产生依赖。好处是模型定义清晰。
* 方案2:融入到最晚就绪的模型里。
比如让在售模型，依赖爆品模型。

## 9.现状：订单模型、订单商品详情，那么订单商品详情模型，该如何建设呢？
订单商品详情作为CDL核心模型，但下游应用时，应该应用非核心模型，即商品分析对象下的各种模型，依赖订单商品模型。下游依赖的是"商品分析对象下"的模型。
