# 背景与总结

# 一、解决如何动态生成sql的问题
## 1.问题简化下：问题核心是事实表应该join哪个维度表的问题，即on的条件的抽象
① 单一主键Primary(PK) 或者 联合主键，其实是一个意思，即允许多个字段组成。
* 保障完整性：即覆盖全部的数据，比如商家维度表。
* 唯一性:多个主键，保障了数据一定是唯一的。如果是分区表，则要带dt作为唯一性主键。
* 不允许为空：因为完整性的考虑，空是不合理的，所以要校验下。

② 唯一键 Unique(UK) 或者 联合唯一键。
是主键的特例，因为主键限制太多了，而且主键应该只有一个表(日周月时间粒度除外，可以允许有日周月三套主键表)
* 唯一性保证即可。

## 2.主键和唯一键区别
* 唯一键，只保障了唯一性，可以允许是空值；也允许不完整，即是主键的子集。
* 比如：商品维度是全局唯一，即主表；某一条业务线的产品模型，则是唯一键标注。

## 3.对模型绑定主键/唯一键 即可


# 二、既然一个维度主键，可以有多个表存在，那我应该路由到哪个表呢，这个是路由规则去约束即可
## 1.那么多表，每一个表又有很多特征，那么哪些特征是可以用来路由的呢？
* 维表/事实表：其中维表很明确，更应该被推荐参与left join。
* 主键：由于兼容唯一性 && 完整性，所以更优先推荐。
* 唯一键: 由于保证了唯一性，所以优先推荐。

## 2.规则:
* 指标所在事实模型优先；
即如果指标和维度都在事实表里存在，避免join过多的表，优先级最高。
* 维表模型 && 主键 优先；
肯定优先join 标注主键的维度表。
* 维表模型 && 唯一键 优先；
其次join 标注唯一键的维度表。
-----尽量不推荐走到这个流程来，如果走到，说明模型建设不到位。
* 非维表模型 && 主键 优先；
推荐 join 有主键的事实表。
* 其他-非维表模型 && 唯一键 —— 随机(稳定/幂等)
推荐 join 有唯一键的事实表。
注意：可能这里会存在多个表都满足条件，面临随机选择一个的时候，要有唯一的排序能力，比如最后按照创建时间排序做兜底，最终目标是保证幂等性，无论怎么查询都会路由到明确的模型里。
